= Architecture
:page-title: Architecture
:toc: left
:tabsize: 2
:sectnums:

Spring AI Bench is designed as a modular, extensible framework for benchmarking AI agents in Java environments.

== System Overview

[source]
----
┌─────────────────────────────────────────────────────────────────┐
│                        Spring AI Bench                         │
├─────────────────┬───────────────────┬──────────────────────────┤
│   bench-core    │   bench-agents    │       bench-app          │
│                 │                   │                          │
│ • Execution     │ • Agent Runners   │ • CLI Interface          │
│ • Sandboxes     │ • Integration     │ • Report Viewing         │
│ • Verification  │ • Auto-Config     │ • Batch Processing       │
│ • Specs         │ • Adapters        │                          │
└─────────────────┴───────────────────┴──────────────────────────┘
            │                 │                    │
            │                 │                    │
┌───────────▼─────────────────▼────────────────────▼──────────────┐
│                    Spring AI Agents                             │
│                                                                 │
│  • ClaudeCodeAgentModel    • GeminiAgentModel                   │
│  • CLI Discovery           • Provider SDKs                     │
│  • Agent Client            • Spring Boot Integration           │
└─────────────────────────────────────────────────────────────────┘
----

== Core Components

=== bench-core Module

The foundational module that provides the execution framework:

==== Execution Engine
* **`BenchHarness`** - Orchestrates the complete benchmark workflow
* **`AgentRunner`** - Interface for agent execution
* **`AgentResult`** - Standardized result format

==== Sandbox System
* **`LocalSandbox`** - Process-based execution in local environment
* **`DockerSandbox`** - Container-based isolation
* **`CloudSandbox`** - Distributed execution (future)

==== Specification System
* **`BenchCase`** - Complete benchmark specification
* **`AgentSpec`** - Agent configuration and prompts
* **`RepoSpec`** - Repository and checkout information
* **`SuccessSpec`** - Success criteria definition

==== Verification System
* **`SuccessVerifier`** - Interface for result verification
* **`VerificationContext`** - Runtime context for verification
* **`VerificationResult`** - Detailed verification outcome

=== bench-agents Module

Integration layer that connects Spring AI Bench with agent implementations:

==== Agent Runners
* **`ClaudeCodeAgentRunner`** - Claude Code CLI integration
* **`GeminiAgentRunner`** - Gemini CLI integration
* **`AgentModelAdapter`** - Generic adapter for Spring AI Agent models

==== Service Layer
* **`WorkspaceService`** - Workspace lifecycle management
* **`ReportService`** - Report generation and output
* **`SimpleLogCapture`** - Structured logging system

==== Configuration
* **`AgentProviderConfig`** - Spring Boot auto-configuration
* **Spring Profiles** - Environment-specific settings

=== bench-app Module

Command-line interface and standalone application:

* **`Main`** - Application entry point
* **CLI parsing** - Command-line argument processing
* **Batch execution** - Multiple benchmark processing
* **Report viewing** - HTML report browser integration

== Execution Flow

[source]
----
1. Specification Loading
   ├── YAML file parsing
   ├── AgentSpec creation
   └── Repository specification

2. Workspace Setup
   ├── Repository cloning
   ├── Workspace isolation
   └── Environment preparation

3. Agent Execution
   ├── Agent model configuration
   ├── CLI process spawning
   ├── Timeout management
   └── Output capture

4. Verification
   ├── Success criteria evaluation
   ├── File system verification
   ├── Command execution
   └── Result compilation

5. Reporting
   ├── HTML report generation
   ├── JSON metadata export
   └── Artifact archival
----

== Package Organization

=== bench-agents Package Structure

After recent refactoring, the package structure follows cohesive organization:

[source]
----
org.springaicommunity.bench.agents/
├── runner/              # Agent runners, services, and configuration
│   ├── AgentModelAdapter
│   ├── ClaudeCodeAgentRunner
│   ├── GeminiAgentRunner
│   ├── AgentProviderConfig
│   ├── WorkspaceService
│   └── ReportService
├── support/             # Utilities and shared support classes
│   ├── CliUtils
│   └── SimpleLogCapture
├── report/              # HTML and JSON report generators
│   ├── HtmlReportGenerator
│   ├── JsonReportGenerator
│   ├── MinimalHtmlReportGenerator
│   ├── MinimalJsonReportGenerator
│   └── IndexPageGenerator
└── verifier/            # Success verification system
    ├── SuccessVerifier
    ├── VerificationContext
    ├── VerificationResult
    ├── Check
    └── HelloWorldVerifier
----

=== Design Principles

* **Single Responsibility** - Each class has a focused purpose
* **DRY Compliance** - Eliminated repeated patterns through service extraction
* **Spring Best Practices** - Proper service layering and dependency injection
* **Package Cohesion** - Related classes grouped logically

== Extension Points

=== Custom Agents

Implement the `AgentRunner` interface:

[source,java]
----
public class CustomAgentRunner implements AgentRunner {

    @Override
    public AgentResult run(Path workspace, AgentSpec spec, Duration timeout)
            throws Exception {
        // Custom agent implementation
        return new AgentResult(exitCode, logFile, duration);
    }
}
----

=== Custom Verification

Implement the `SuccessVerifier` interface:

[source,java]
----
public class CustomVerifier implements SuccessVerifier {

    @Override
    public VerificationResult verify(VerificationContext context) {
        // Custom verification logic
        return new VerificationResult(success, reason, checks);
    }
}
----

=== Custom Sandboxes

Implement the `Sandbox` interface:

[source,java]
----
public class CustomSandbox implements Sandbox {

    @Override
    public ExecResult exec(ExecSpec spec) throws Exception {
        // Custom execution environment
        return new ExecResult(exitCode, stdout, stderr, duration);
    }
}
----

== Security Model

=== Sandbox Isolation

- **Process Isolation** - Separate processes for agent execution
- **Filesystem Isolation** - Temporary workspaces with cleanup
- **Network Controls** - Optional network isolation in Docker mode
- **Resource Limits** - CPU, memory, and time constraints

=== Secret Management

- **Environment Variables** - Secure API key handling
- **No Secret Logging** - Careful avoidance of secret exposure
- **Workspace Cleanup** - Automatic cleanup of sensitive data

== Performance Characteristics

=== Scalability

- **Parallel Execution** - Multiple benchmarks can run concurrently
- **Resource Management** - Configurable resource limits
- **Cleanup Efficiency** - Automatic workspace and process cleanup

=== Monitoring

- **Structured Logging** - Comprehensive execution logging
- **Metrics Integration** - Ready for Micrometer integration
- **Report Generation** - Detailed HTML and JSON reports

== Spring Java Format

The project uses Spring Java Format for consistent code formatting:

[source,bash]
----
# Apply formatting
./mvnw spring-javaformat:apply

# Validate formatting
./mvnw spring-javaformat:validate
----

This ensures all code follows Spring's established conventions for readability and maintainability.